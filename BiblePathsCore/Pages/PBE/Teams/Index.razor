@page "/pbe/teams/{BibleId?}"
@attribute [Authorize]
@using BiblePathsCore.Models
@using BiblePathsCore.Models.DB
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop

@inject BiblePathsCoreDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime js

<div class="container mt-2">
    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @ErrorMessage
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>My PBE Teams</h4>
        <button type="button" class="btn btn-primary" @onclick="ShowAddTeamModal">+ Add New Team</button>
    </div>

    @if (LoadingTeams)
    {
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm mr-2"></span>
            Loading your teams...
        </div>
    }
    else if (Teams == null || Teams.Count == 0)
    {
        <div class="alert alert-warning">
            No teams found. <a href="#" @onclick="ShowAddTeamModal">Create your first team!</a>
        </div>
    }
    else
    {
        <div class="row">
            <table class="table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var team in Teams)
                {
                    <tr>
                        <td class="m-2"><h5 class="mb-0">@team.Name</h5></td>
                        <td class="m-2">
                            <div class="small">Members: @team.QuizTeamMembers.Count</div>
                            <div class="small">Coaches: @team.QuizTeamCoaches.Count</div>
                            <div class="small">Assignments: @team.QuizTeamMemberAssignments.Count</div>
                        </td>
                        <td class="m-2">
                            <button type="button" class="btn btn-sm btn-info" @onclick="() => SelectTeam(team)">Manage</button>
                            <button type="button" class="btn btn-sm btn-warning" @onclick="() => ShowEditTeamModal(team)">Rename</button>
                            <button type="button" class="btn btn-sm btn-danger" @onclick="() => DeleteTeam(team.Id)">Delete</button>
                            <a href="/pbe/teams/quizhistory/@team.Id" class="btn btn-sm btn-success">Quizzes</a>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }

    <!-- Team Details Section -->
    @if (SelectedTeam != null)
    {
        <hr class="my-5" />
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">@SelectedTeam.Name</h4>
                <button type="button" class="close text-white" @onclick="() => SelectedTeam = null" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="card-body">
                <!-- Tabs for different sections -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link @(ActiveTab == "members" ? "active" : "")" href="#" @onclick="@((e) => {SetActiveTab("members"); })" @onclick:preventDefault="true">Members</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ActiveTab == "coaches" ? "active" : "")" href="#" @onclick="@((e) => {SetActiveTab("coaches"); })" @onclick:preventDefault="true">Coaches</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ActiveTab == "assignments" ? "active" : "")" href="#" @onclick="@((e) => {SetActiveTab("assignments"); })" @onclick:preventDefault="true">Assignments</a>
                    </li>
                </ul>

                <!-- Members Tab -->
                @if (ActiveTab == "members")
                {
                    <div class="tab-pane fade show active">
                        <h5 class="mb-3">Team Members</h5>
                        <button type="button" class="btn btn-success btn-sm mb-3" @onclick="ShowAddMemberModal">+ Add Member</button>
                        
                        @if (SelectedTeam.QuizTeamMembers.Count == 0)
                        {
                            <p class="text-muted">No members in this team yet.</p>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var member in SelectedTeam.QuizTeamMembers)
                                        {
                                            <tr>
                                                <td>@member.Name</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-warning" @onclick="() => ShowEditMemberModal(member)">Edit</button>
                                                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => DeleteMember(member.Id)">Remove</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }

                <!-- Coaches Tab -->
                @if (ActiveTab == "coaches")
                {
                    <div class="tab-pane fade show active">
                        <h5 class="mb-3">Team Coaches</h5>
                        <button type="button" class="btn btn-success btn-sm mb-3" @onclick="ShowAddCoachModal">+ Add Coach</button>
                        
                        @if (SelectedTeam.QuizTeamCoaches.Count == 0)
                        {
                            <p class="text-muted">No coaches assigned to this team yet.</p>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Coach Email</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var coach in SelectedTeam.QuizTeamCoaches)
                                        {
                                            <tr>
                                                <td>@coach.Coach.Email</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => DeleteCoach(coach.Id)">Remove</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }

                <!-- Assignments Tab -->
                @if (ActiveTab == "assignments")
                {
                    <div class="tab-pane fade show active">
                        <h5 class="mb-3">Assignments</h5>
                        <button type="button" class="btn btn-success btn-sm mb-3" @onclick="ShowAddAssignmentModal">+ Assign Chapters</button>
                        
                        @if (SelectedTeamAssignments.Count == 0)
                        {
                            <p class="text-muted">No chapter assignments yet.</p>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Assignments</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var MemberAssignment in SelectedTeamAssignments.DistinctBy(a => a.Member))
                                        {
                                            <tr @key="MemberAssignment.Id">
                                                <td>@MemberAssignment.Member.Name</td>
                                                <td>
                                                    @foreach (var assignment in SelectedTeamAssignments.Where(a => a.MemberId == MemberAssignment.MemberId).OrderBy(a => a.BookNumber).ThenBy(a => a.ChapterNumber))
                                                    {
                                                <div class="badge badge-light">
                                                    @assignment.BookName: 
                                                    @if (assignment.ChapterNumber != Bible.CommentaryChapter)
                                                    {
                                                        <span> @assignment.ChapterNumber </span>
                                                    }
                                                    else
                                                    {
                                                        <span> Bible Commentary </span>
                                                    }
                                                    <button type="button" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0 4px; font-size: 14px; line-height: 1;" @onclick="() => DeleteAssignment(assignment.Id)">&times;</button>
                                                </div>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Add/Edit Team Modal -->
@if (ShowTeamModal)
{
    <div class="modal d-block" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(IsEditingTeam ? "Edit Team" : "Add New Team")</h5>
                    <button type="button" class="close" @onclick="CloseTeamModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="teamName">Team Name</label>
                        <input type="text" class="form-control" id="teamName" @bind="NewTeam.Name" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTeamModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTeam">@(IsEditingTeam ? "Update" : "Create") Team</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add/Edit Member Modal -->
@if (ShowMemberModal)
{
    <div class="modal d-block" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(IsEditingMember ? "Edit Member" : "Add New Member")</h5>
                    <button type="button" class="close" @onclick="CloseMemberModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="memberName">Member Name</label>
                        <input type="text" class="form-control" id="memberName" @bind="NewMember.Name" />
                    </div>
@*                     <div class="form-group">
                        <label for="memberEmail">Email</label>
                        <input type="email" class="form-control" id="memberEmail" @bind="NewMember.Email" />
                    </div> *@
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseMemberModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveMember">@(IsEditingMember ? "Update" : "Add") Member</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Coach Modal -->
@if (ShowCoachModal)
{
    <div class="modal d-block" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Coach to Team</h5>
                    <button type="button" class="close" @onclick="CloseCoachModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="coachEmail">Coach Email Address</label>
                        <input type="email" class="form-control" id="coachEmail" 
                               placeholder="Enter coach email..." 
                               @onchange="@(async (ChangeEventArgs e) => { 
                                   CoachEmailInput = e.Value?.ToString() ?? string.Empty; 
                                   await ValidateCoachEmail(e); 
                               })" />
                        
                        @if (!string.IsNullOrWhiteSpace(CoachValidationMessage))
                        {
                            <small class="d-block mt-2 @(CoachEmailExists ? "text-success" : "text-danger")">
                                @CoachValidationMessage
                            </small>
                        }
                        
                        @if (CoachEmailExists && SelectedCoach != null)
                        {
                            <small class="d-block mt-2 text-info">
                                Found: @SelectedCoach.Email
                            </small>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCoachModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCoach" 
                            disabled="@(!CoachEmailExists || SelectedCoach == null)">
                        Add Coach
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Assignment Modal -->
@if (ShowAssignmentModal)
{
    <div class="modal d-block" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Chapters to Member</h5>
                    <button type="button" class="close" @onclick="CloseAssignmentModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(AssignmentErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @AssignmentErrorMessage
                        </div>
                    }
                    <div class="form-group">
                        <label for="memberSelect">Select Member</label>
                        <select class="form-control" id="memberSelect" 
                                value="@SelectedAssignmentMemberId.ToString()" 
                                @onchange="@(async (ChangeEventArgs e) => { 
                                    if (int.TryParse(e.Value?.ToString(), out int memberId)) 
                                    { 
                                        SelectedAssignmentMemberId = memberId; 
                                        await OnMemberSelected(e); 
                                    } 
                                })">
                            <option value="0">-- Select a Member --</option>
                            @foreach (var member in SelectedTeam?.QuizTeamMembers ?? new List<QuizTeamMember>())
                            {
                                <option value="@member.Id">@member.Name</option>
                            }
                        </select>
                    </div>

                    @if (SelectedAssignmentMemberId > 0)
                    {
                        <div class="form-group">
                            <label for="bookSelect">Select Book</label>
                            <select class="form-control" id="bookSelect" 
                                    value="@SelectedBookNumber.ToString()" 
                                    @onchange="@(async (ChangeEventArgs e) => { 
                                        if (int.TryParse(e.Value?.ToString(), out int bookNumber)) 
                                        { 
                                            SelectedBookNumber = bookNumber; 
                                            await OnBookSelected(e); 
                                        } 
                                    })">
                                <option value="0">-- Select a Book --</option>
                                @foreach (var book in AvailableBooks)
                                {
                                    <option value="@book.BookNumber">@book.Name</option>
                                }
                            </select>
                        </div>

                        @if (SelectedBookNumber > 0)
                        {
                            <div class="form-group">
                                <label for="chapterSelect">Select Chapters</label>
                                <div class="chapters-selection">
                                    <div class="form-group">
                                        <h6>Select Chapters</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="chapterFrom">From Chapter:</label>
                                                <select class="form-control" id="chapterFrom" 
                                                        @onchange="@((ChangeEventArgs e) => OnChapterFromSelected(e))">
                                                    <option value="0">-- Select a Chapter --</option>
                                                    @foreach (var chapter in ChapterSelectList)
                                                    {
                                                        <option value="@chapter.Value">@chapter.Text</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="chapterTo">To Chapter:</label>
                                                <select class="form-control" id="chapterTo" 
                                                        @onchange="@((ChangeEventArgs e) => OnChapterToSelected(e))">
                                                    <option value="0">-- Select a Chapter --</option>
                                                    @foreach (var chapter in ToChapterSelectList)
                                                    {
                                                        <option value="@chapter.Value">@chapter.Text</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label>&nbsp;</label>
                                                <button class="btn btn-info btn-block" @onclick="AddChapterRange">Add Range</button>
                                            </div>
                                        </div>

                                        @if (SelectedChapters.Any())
                                        {
                                            <div class="alert alert-info">
                                                <strong>Selected Chapters (@SelectedChapters.Count):</strong>
                                                <div class="mt-2">
                                                    @foreach (var chapter in SelectedChapters.OrderBy(c => c))
                                                    {
                                                        <span class="badge badge-primary mr-1 mb-1">
                                                            @if (chapter != @Bible.CommentaryChapter)
                                                            {
                                                                @chapter
                                                            }
                                                            else
                                                            {
                                                                <span>Bible Commentary</span>
                                                            }
                                                            <button type="button" class="close ml-1" @onclick="() => SelectedChapters.Remove(chapter)">
                                                                <span>&times;</span>
                                                            </button>
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>  <!-- â† ADDED: closes outer form-group -->
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAssignmentModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveAssignments" disabled="@(SelectedAssignmentMemberId == 0 || SelectedChapters.Count == 0)">Assign</button>
                </div>
            </div>
        </div>
    </div>
}
<div>
    <hr />
    <a href="/PBE/Quizzes?BibleId=@BibleId">Back to Quizzes</a>
    <br />
    <a href="/PBE/Index">Back to PBE Home</a>
</div>

@code {

    [Parameter]
    [SupplyParameterFromQuery(Name = "BibleId")]
    public string BibleId { get; set; }

    // Optional error message shown in the UI when set
    private string ErrorMessage { get; set; } = string.Empty;
    private string AssignmentErrorMessage { get; set; } = string.Empty;

    private List<QuizTeam> Teams = new();
    private QuizTeam SelectedTeam;
    private QuizTeam NewTeam = new();
    private QuizTeamMember NewMember = new();
    private QuizTeamCoach NewCoach = new();
    private List<QuizTeamMemberAssignment> SelectedTeamAssignments = new();
    private List<QuizUser> AvailableCoaches = new();
    private List<BibleBook> AvailableBooks = new();
    private List<int> AvailableChapters = new();
    private QuizUser CurrentUser;
    private string CurrentUserEmail = "";
    private string ActiveTab = "members";

    // Modal states
    private bool ShowTeamModal = false;
    private bool ShowMemberModal = false;
    private bool ShowCoachModal = false;
    private bool ShowAssignmentModal = false;
    private bool IsEditingTeam = false;
    private bool IsEditingMember = false;
    private bool LoadingTeams = false;
    private bool TeamInitialized = false;

    // Assignment tracking
    private int SelectedAssignmentMemberId = 0;
    private int SelectedBookNumber = 0;
    private BibleBook SelectedBook = new();
    private List<SelectListItem> ChapterSelectList = new();
    private List<SelectListItem> ToChapterSelectList = new();
    private List<int> SelectedChapters = new();

    // Coach email validation
    private string CoachEmailInput = string.Empty;
    private string CoachValidationMessage = string.Empty;
    private bool CoachEmailExists = false;
    private QuizUser SelectedCoach;

    private int ChapterRangeFrom = 0;
    private int ChapterRangeTo = 0;

    protected override Task OnInitializedAsync()
    {
        LoadingTeams = true;
        // nothing heavy here - OnParametersSetAsync will handle defaults and initialization
        return base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Ensure a valid BibleId
        BibleId = await QuizQuestion.GetValidBibleIdAsync(DbContext, BibleId);
        if (!TeamInitialized)
        {
            await LoadTeams();
        }
    }

    private async Task LoadTeams()
    {
        LoadingTeams = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            CurrentUserEmail = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
            CurrentUser = await QuizUser.GetOrAddPBEUserAsync(DbContext, CurrentUserEmail);

            // Load teams where user is owner or coach
            Teams = await QuizTeam.GetAllMyTeamsAsync(DbContext, CurrentUser, BibleId);

            // Load available books
            AvailableBooks = await BibleBook.GetBooksByBibleIDAsync(DbContext, BibleId);
        }
        finally
        {
            TeamInitialized = true;
            LoadingTeams = false;
        }
    }

    private void ShowAddTeamModal()
    {
        NewTeam = new QuizTeam();
        IsEditingTeam = false;
        ShowTeamModal = true;
    }

    private void ShowEditTeamModal(QuizTeam team)
    {
        NewTeam = new QuizTeam { Id = team.Id, Name = team.Name };
        IsEditingTeam = true;
        ShowTeamModal = true;
    }

    private void CloseTeamModal()
    {
        ShowTeamModal = false;
    }

    private async Task SaveTeam()
    {
        ErrorMessage = string.Empty;
        try
        {
            if (IsEditingTeam)
            {
                var existingTeam = await DbContext.QuizTeams.FindAsync(NewTeam.Id);
                existingTeam.Name = NewTeam.Name;
                existingTeam.Modified = DateTimeOffset.Now;
                DbContext.QuizTeams.Update(existingTeam);
            }
            else
            {
                NewTeam.Owner = CurrentUserEmail;
                NewTeam.Created = DateTimeOffset.Now;
                NewTeam.Modified = DateTimeOffset.Now;
                DbContext.QuizTeams.Add(NewTeam);
            }

            await DbContext.SaveChangesAsync();
            TeamInitialized = false;
            await LoadTeams();
            CloseTeamModal();
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while saving the team: " + ex.Message;
            Console.WriteLine($"Error saving team: {ex.Message}");
        }
    }

    private async Task DeleteTeam(int teamId)
    {
        if (!await ConfirmDelete("Are you sure you want to delete this team?"))
            return;

        try
        {
            var team = await DbContext.QuizTeams.FindAsync(teamId);
            if (team != null)
            {
                if (!await team.DeleteTeamAsync(DbContext)) { ErrorMessage = "We were unable to delete this team"; }
                TeamInitialized = false;
                await LoadTeams();
                if (SelectedTeam?.Id == teamId)
                    SelectedTeam = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting team: {ex.Message}");
        }
    }

    private void SelectTeam(QuizTeam team)
    {
        SelectedTeam = team;
        SelectedTeamAssignments = team.QuizTeamMemberAssignments.ToList();
        ActiveTab = "members";
    }

    private void ShowAddMemberModal()
    {
        NewMember = new QuizTeamMember();
        IsEditingMember = false;
        ShowMemberModal = true;
    }

    private void ShowEditMemberModal(QuizTeamMember member)
    {
        NewMember = new QuizTeamMember 
        { 
            Id = member.Id, 
            Name = member.Name, 
        };
        IsEditingMember = true;
        ShowMemberModal = true;
    }

    private void CloseMemberModal()
    {
        ShowMemberModal = false;
    }

    private async Task SaveMember()
    {
        try
        {
            if (SelectedTeam == null) return;

            if (IsEditingMember)
            {
                var existingMember = await DbContext.QuizTeamMembers.FindAsync(NewMember.Id);
                existingMember.Name = NewMember.Name;
                //existingMember.Email = NewMember.Email;
                existingMember.Modified = DateTimeOffset.Now;
                DbContext.QuizTeamMembers.Update(existingMember);
            }
            else
            {
                NewMember.TeamId = SelectedTeam.Id;
                NewMember.Owner = CurrentUserEmail;
                NewMember.Created = DateTimeOffset.Now;
                NewMember.Modified = DateTimeOffset.Now;
                DbContext.QuizTeamMembers.Add(NewMember);
            }

            await DbContext.SaveChangesAsync();
            await ReloadSelectedTeam();
            CloseMemberModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving member: {ex.Message}");
        }
    }

    private async Task DeleteMember(int memberId)
    {
        ErrorMessage = string.Empty;
        if (!await ConfirmDelete("Are you sure you want to remove this member?"))
            return;

        try
        {
            var member = await DbContext.QuizTeamMembers.FindAsync(memberId);
            if (member != null)
            {
                // DbContext.QuizTeamMembers.Remove(member);
                // await DbContext.SaveChangesAsync();
                if (!await SelectedTeam.DeleteTeamMemberAsync(DbContext, member)) { ErrorMessage = "We were unable to delete this Team Mamber"; }
                await ReloadSelectedTeam();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while deleting the member: " + ex.Message;
            Console.WriteLine($"Error deleting member: {ex.Message}");
        }
    }

    private void ShowAddCoachModal()
    {
        NewCoach = new QuizTeamCoach();
        ShowCoachModal = true;
    }

    private void CloseCoachModal()
    {
        ShowCoachModal = false;
    }

    private async Task SaveCoach()
    {
        ErrorMessage = string.Empty;
        try
        {
            if (SelectedTeam == null || NewCoach.CoachId == 0) return;

            NewCoach.TeamId = SelectedTeam.Id;
            NewCoach.CoachId = SelectedCoach.Id;
            NewCoach.Created = DateTimeOffset.Now;
            NewCoach.Modified = DateTimeOffset.Now;
            DbContext.QuizTeamCoaches.Add(NewCoach);
            await DbContext.SaveChangesAsync();
            await ReloadSelectedTeam();
            CloseCoachModal();
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while saving the coach: " + ex.Message;
            Console.WriteLine($"Error saving coach: {ex.Message}");
        }
    }

    private async Task DeleteCoach(int coachId)
    {
        ErrorMessage = string.Empty;
        if (!await ConfirmDelete("Are you sure you want to remove this coach?"))
            return;

        try
        {
            var coach = await DbContext.QuizTeamCoaches.FindAsync(coachId);
            if (coach != null)
            {
                DbContext.QuizTeamCoaches.Remove(coach);
                await DbContext.SaveChangesAsync();
                await ReloadSelectedTeam();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while deleting the coach: " + ex.Message;
            Console.WriteLine($"Error deleting coach: {ex.Message}");
        }
    }

    private void ShowAddAssignmentModal()
    {
        SelectedAssignmentMemberId = 0;
        SelectedBookNumber = 0;
        SelectedChapters.Clear();
        ShowAssignmentModal = true;
    }

    private void CloseAssignmentModal()
    {
        ShowAssignmentModal = false;
        SelectedAssignmentMemberId = 0;
        SelectedBookNumber = 0;
        SelectedChapters.Clear();
        ChapterRangeFrom = 0;
        ChapterRangeTo = 0;
    }

    private async Task OnMemberSelected(ChangeEventArgs e)
    {
        SelectedBookNumber = 0;
        SelectedChapters.Clear();
        await Task.CompletedTask;
    }

    private async Task OnBookSelected(ChangeEventArgs e)
    {
        SelectedChapters.Clear();
        if (int.TryParse(e.Value?.ToString(), out int bookNumber) && bookNumber > 0)
        {
            //Get opur SelectedBook so we can retrieve a chapter select list.
            SelectedBook = AvailableBooks.Where(b => b.BookNumber == bookNumber).FirstOrDefault();
            ChapterSelectList = await SelectedBook.GetChapterAndCommentarySelectListAsync(DbContext, BibleId);
            ToChapterSelectList = ChapterSelectList;
        }
        else
        {
            AvailableChapters.Clear();
        }
    }

    private void OnChapterToggled(int chapter, bool isSelected)
    {
        if (isSelected && !SelectedChapters.Contains(chapter))
        {
            SelectedChapters.Add(chapter);
        }
        else if (!isSelected && SelectedChapters.Contains(chapter))
        {
            SelectedChapters.Remove(chapter);
        }
    }

    private void OnChapterFromSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int fromChapter))
        {
            ChapterRangeFrom = fromChapter;

            // If ChapterRangeFrom is set and ChapterRangeTo is not set (0), set it to the same value
            if (ChapterRangeFrom > 0 && ChapterRangeTo == 0)
            {
                ChapterRangeTo = ChapterRangeFrom;
            }
            // If ChapterRangeTo is already set but is less than ChapterRangeFrom, adjust it
            else if (ChapterRangeFrom > 0 && ChapterRangeTo > 0 && ChapterRangeTo < ChapterRangeFrom)
            {
                ChapterRangeTo = ChapterRangeFrom;
            }

            // Let's update ToChapterSelectList to exclude chapters less than ChapterRangeFrom
            ToChapterSelectList = ChapterSelectList
                .Where(c => int.Parse(c.Value) >= ChapterRangeFrom)
                .ToList();
        }
    }

    private void OnChapterToSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int toChapter))
        {
            // Ensure ChapterRangeTo is not less than ChapterRangeFrom
            if (ChapterRangeFrom > 0 && toChapter > 0 && toChapter < ChapterRangeFrom)
            {
                AssignmentErrorMessage = $"To Chapter must be greater than or equal to From Chapter ({ChapterRangeFrom}).";
                ChapterRangeTo = ChapterRangeFrom; // Reset to ChapterRangeFrom
            }
            else
            {
                ChapterRangeTo = toChapter;
                ErrorMessage = string.Empty;
            }
        }
    }

    private void AddChapterRange()
    {
        if (ChapterRangeFrom == 0 || ChapterRangeTo == 0 || ChapterRangeFrom > ChapterRangeTo)
        {
            AssignmentErrorMessage = "Please select a valid range.";
            return;
        }

        for (int chapter = ChapterRangeFrom; chapter <= ChapterRangeTo && chapter <= SelectedBook.Chapters; chapter++)
        {
            if (!SelectedChapters.Contains(chapter))
                SelectedChapters.Add(chapter);
        }
        // And handle the Commentary Scenario one-off
        if (ChapterRangeTo == Bible.CommentaryChapter)
        {
            if (!SelectedChapters.Contains(Bible.CommentaryChapter))
                SelectedChapters.Add(Bible.CommentaryChapter);
        }
        ChapterRangeFrom = 0;
        ChapterRangeTo = 0;
    }

    private async Task SaveAssignments()
    {
        try
        {
            if (SelectedTeam == null || SelectedAssignmentMemberId == 0 || SelectedChapters.Count == 0)
                return;

            foreach (var chapter in SelectedChapters)
            {
                var assignment = new QuizTeamMemberAssignment
                {
                    TeamId = SelectedTeam.Id,
                    MemberId = SelectedAssignmentMemberId,
                    BookNumber = SelectedBookNumber,
                    ChapterNumber = chapter,
                    Created = DateTimeOffset.Now,
                    Modified = DateTimeOffset.Now
                };
                DbContext.QuizTeamMemberAssignments.Add(assignment);
            }

            await DbContext.SaveChangesAsync();
            await ReloadSelectedTeam();
            CloseAssignmentModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving assignments: {ex.Message}");
        }
    }

    private async Task DeleteAssignment(int assignmentId)
    {
        // if (!await ConfirmDelete("Are you sure you want to remove this assignment?"))
        //     return;

        try
        {
            var assignment = await DbContext.QuizTeamMemberAssignments.FindAsync(assignmentId);
            if (assignment != null)
            {
                DbContext.QuizTeamMemberAssignments.Remove(assignment);
                await DbContext.SaveChangesAsync();
                await ReloadSelectedTeam();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting assignment: {ex.Message}");
        }
    }

    private async Task ReloadSelectedTeam()
    {
        if (SelectedTeam != null)
        {
            SelectedTeam = await QuizTeam.GetTeamByIdAsync(DbContext, SelectedTeam.Id, BibleId);

            SelectedTeamAssignments = SelectedTeam.QuizTeamMemberAssignments.ToList();
        }
    }

    private void SetActiveTab(string tab)
    {
        ActiveTab = tab;
    }

    private async Task<bool> ConfirmDelete(string message)
    {
        return await js.InvokeAsync<bool>("confirm", message);
    }

    private async Task ValidateCoachEmail(ChangeEventArgs e)
    {
        CoachValidationMessage = "Validating...";
        CoachEmailExists = false;
        SelectedCoach = null;

        var email = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(email))
        {
            CoachValidationMessage = "Email is required.";
            return;
        }

        // Check if the email is in the correct format
        if (!new System.ComponentModel.DataAnnotations.EmailAddressAttribute().IsValid(email))
        {
            CoachValidationMessage = "Invalid email format.";
            return;
        }

        // Simulate server-side email validation
        await Task.Delay(500);

        // Check if the coach exists in the system
        var coach = await DbContext.QuizUsers.FirstOrDefaultAsync(u => u.Email == email);
        if (coach != null)
        {
            CoachEmailExists = true;
            SelectedCoach = coach;
            CoachValidationMessage = "Coach email found.";
        }
        else
        {
            CoachEmailExists = false;
            CoachValidationMessage = "Coach email not found.";
        }
    }
}